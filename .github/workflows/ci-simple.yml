# Reliable API Test Automation
name: API Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - smoke
        - regression
      test_class:
        description: 'Specific test class (optional, e.g., HealthCheckTest)'
        required: false
        default: ''
        type: string

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run API Tests
      run: |
        SUITE=${{ github.event.inputs.test_suite || 'all' }}
        TEST_CLASS="${{ github.event.inputs.test_class }}"
        
        echo "üß™ Running $SUITE tests..."
        
        # Build test command
        MVN_CMD="mvn clean test -Denv=dev -Pci --batch-mode --no-transfer-progress"
        
        # Add specific test class if provided
        if [ -n "$TEST_CLASS" ]; then
          echo "üìå Running specific test: $TEST_CLASS"
          MVN_CMD="$MVN_CMD -Dtest=$TEST_CLASS"
        else
          # Run all billpay tests
          MVN_CMD="$MVN_CMD -Dtest=com.api.automation.tests.billpay.**"
        fi
        
        echo "Command: $MVN_CMD"
        $MVN_CMD || true  # Continue even if tests fail to generate reports
      env:
        MAVEN_OPTS: "-Xmx2048m -Xms512m"
      continue-on-error: true

    - name: Display Test Results
      if: always()
      run: |
        echo "=== Test Execution Complete ===" 
        
        # Add to GitHub Step Summary
        echo "## üß™ API Test Results" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** dev" >> $GITHUB_STEP_SUMMARY
        echo "**Test Suite:** ${{ github.event.inputs.test_suite || 'smoke' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "target/surefire-reports" ]; then
          echo "‚úÖ Test reports generated"
          
          # Simple test count
          XML_FILES=$(find target/surefire-reports -name "TEST-*.xml" 2>/dev/null || echo "")
          if [ -n "$XML_FILES" ]; then
            echo "üìä Test report files found:"
            ls -la target/surefire-reports/TEST-*.xml || true
            
            # Parse test results for summary
            TOTAL_TESTS=0
            FAILURES=0
            ERRORS=0
            SKIPPED=0
            
            for file in target/surefire-reports/TEST-*.xml; do
              if [ -f "$file" ]; then
                # Extract numbers from XML attributes
                TESTS=$(grep -o 'tests="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
                FAILS=$(grep -o 'failures="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
                ERRS=$(grep -o 'errors="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
                SKIP=$(grep -o 'skipped="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
                
                TOTAL_TESTS=$((TOTAL_TESTS + ${TESTS:-0}))
                FAILURES=$((FAILURES + ${FAILS:-0}))
                ERRORS=$((ERRORS + ${ERRS:-0}))
                SKIPPED=$((SKIPPED + ${SKIP:-0}))
              fi
            done
            
            PASSED=$((TOTAL_TESTS - FAILURES - ERRORS - SKIPPED))
            
            # Add results table to GitHub Summary
            echo "### Test Results Summary" >> $GITHUB_STEP_SUMMARY
            echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| üìä **Total Tests** | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ **Passed** | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå **Failed** | $FAILURES |" >> $GITHUB_STEP_SUMMARY
            echo "| üî• **Errors** | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚è≠Ô∏è **Skipped** | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Add status badge
            if [ "$FAILURES" -eq 0 ] && [ "$ERRORS" -eq 0 ]; then
              echo "### üéâ **All Tests Passed!** ‚úÖ" >> $GITHUB_STEP_SUMMARY
            else
              echo "### ‚ö†Ô∏è **Some Tests Failed** ‚ùå" >> $GITHUB_STEP_SUMMARY
              echo "- Failed: $FAILURES" >> $GITHUB_STEP_SUMMARY
              echo "- Errors: $ERRORS" >> $GITHUB_STEP_SUMMARY
            fi
            
            # Console output for logs
            echo "üìä Test Summary: Total=$TOTAL_TESTS, Passed=$PASSED, Failed=$FAILURES, Errors=$ERRORS, Skipped=$SKIPPED"
          else
            echo "‚ö†Ô∏è No XML test reports found"
            echo "‚ö†Ô∏è No test reports found" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚ùå No surefire-reports directory found"
          echo "‚ùå No test execution detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Show any log files
        if [ -d "logs" ]; then
          echo "üìù Log files available:"
          ls -la logs/ || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÅ **Log files available in artifacts**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Generate Allure Report
      if: always()
      run: |
        echo "üìä Generating Allure Report..."
        if [ -d "allure-results" ]; then
          mvn allure:report --batch-mode || echo "‚ö†Ô∏è Allure report generation had issues"
          echo "‚úÖ Allure report generated"
          
          # Verify report was generated
          if [ -d "target/site/allure-maven-plugin" ]; then
            # Copy entire report to public directory for GitHub Pages
            mkdir -p public
            cp -r target/site/allure-maven-plugin/* public/
            
            # Create .nojekyll to allow underscored files/folders (_/data, etc.)
            touch public/.nojekyll
            
            # Verify key files exist
            echo "üìÅ Report contents:"
            ls -la public/
            
            # Check for required Allure files
            if [ -f "public/index.html" ]; then
              echo "‚úÖ index.html present"
            fi
            if [ -d "public/data" ]; then
              echo "‚úÖ data/ directory present"
              ls -la public/data/
            fi
            if [ -d "public/export" ]; then
              echo "‚úÖ export/ directory present"
            fi
            if [ -d "public/history" ]; then
              echo "‚úÖ history/ directory present"
            fi
            if [ -d "public/widgets" ]; then
              echo "‚úÖ widgets/ directory present"
            fi
            
            echo "‚úÖ Allure report ready for deployment"
          else
            echo "‚ùå Allure report directory not found after generation"
            mkdir -p public
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>API Test Report</title></head><body><h1>Report Generation Failed</h1><p>Allure report could not be generated. Check the workflow logs.</p></body></html>' > public/index.html
            touch public/.nojekyll
          fi
        else
          echo "‚ö†Ô∏è No allure-results directory found"
          # Create a placeholder page
          mkdir -p public
          echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>API Test Report - No Results</title><style>body{font-family:Arial,sans-serif;max-width:800px;margin:50px auto;padding:20px}h1{color:#333}.info{background:#f0f0f0;padding:20px;border-radius:8px}</style></head><body><h1>üìä API Test Report</h1><div class="info"><h2>No test results available</h2><p>The test suite needs to be executed to generate the Allure report.</p><p>Trigger a new workflow run to see results here.</p></div></body></html>' > public/index.html
          touch public/.nojekyll
        fi

    - name: Setup Pages
      if: always() && github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      uses: actions/configure-pages@v4

    - name: Upload Pages Artifact
      if: always() && github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
      uses: actions/upload-pages-artifact@v3
      with:
        path: public/

    - name: Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          target/surefire-reports/
          test-output/
          logs/
        retention-days: 5
        if-no-files-found: ignore

    - name: Upload Allure Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-results
        path: allure-results/
        retention-days: 5
        if-no-files-found: ignore

    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: target/site/allure-maven-plugin/
        retention-days: 5
        if-no-files-found: ignore

    - name: Validate Test Results
      if: always()
      run: |
        echo "=== Validating Test Results ==="
        
        # Check if surefire reports directory exists
        if [ ! -d "target/surefire-reports" ]; then
          echo "‚ö†Ô∏è No surefire-reports directory found"
          echo "TEST_STATUS=no-reports" >> $GITHUB_ENV
          exit 0  # Don't fail - allow report deployment
        fi
        
        # Check if any XML test reports exist
        XML_COUNT=$(find target/surefire-reports -name "TEST-*.xml" 2>/dev/null | wc -l)
        if [ "$XML_COUNT" -eq 0 ]; then
          echo "‚ö†Ô∏è No XML test reports found"
          echo "TEST_STATUS=no-reports" >> $GITHUB_ENV
          exit 0  # Don't fail - allow report deployment
        fi
        
        echo "‚úÖ Found $XML_COUNT test report file(s)"
        
        # Check for test failures or errors
        FAILURE_COUNT=0
        ERROR_COUNT=0
        
        for file in target/surefire-reports/TEST-*.xml; do
          if [ -f "$file" ]; then
            # Extract failure and error counts
            FAILURES=$(grep -o 'failures="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
            ERRORS=$(grep -o 'errors="[0-9]*"' "$file" | grep -o '[0-9]*' || echo "0")
            
            FAILURE_COUNT=$((FAILURE_COUNT + ${FAILURES:-0}))
            ERROR_COUNT=$((ERROR_COUNT + ${ERRORS:-0}))
          fi
        done
        
        echo "Test Results: Failures=$FAILURE_COUNT, Errors=$ERROR_COUNT"
        
        if [ "$FAILURE_COUNT" -gt 0 ]; then
          echo "‚ö†Ô∏è Found $FAILURE_COUNT test failure(s) - check Allure report for details"
          echo "TEST_STATUS=failures" >> $GITHUB_ENV
        elif [ "$ERROR_COUNT" -gt 0 ]; then
          echo "‚ö†Ô∏è Found $ERROR_COUNT test error(s) - check Allure report for details"
          echo "TEST_STATUS=errors" >> $GITHUB_ENV
        else
          echo "‚úÖ All tests passed successfully!"
          echo "TEST_STATUS=passed" >> $GITHUB_ENV
        fi
        
        # Always exit 0 to allow Allure report deployment
        # The report itself will show test failures
        exit 0

    - name: Create Status Check
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          // Only create status for non-PR events to avoid permission issues
          if (context.eventName !== 'pull_request') {
            try {
              // Read test results
              const fs = require('fs');
              const path = require('path');
              
              let status = 'success';
              let description = 'All tests passed';
              
              try {
                // Check if test reports exist
                const reportsDir = 'target/surefire-reports';
                if (fs.existsSync(reportsDir)) {
                  const files = fs.readdirSync(reportsDir).filter(f => f.startsWith('TEST-') && f.endsWith('.xml'));
                  
                  if (files.length > 0) {
                    // Simple check for failures/errors in filenames or basic content
                    let hasFailures = false;
                    for (const file of files) {
                      const content = fs.readFileSync(path.join(reportsDir, file), 'utf8');
                      if (content.includes('failures="') && !content.includes('failures="0"')) {
                        hasFailures = true;
                        break;
                      }
                      if (content.includes('errors="') && !content.includes('errors="0"')) {
                        hasFailures = true;
                        break;
                      }
                    }
                    
                    if (hasFailures) {
                      status = 'failure';
                      description = 'Some tests failed';
                    } else {
                      description = `All tests passed (${files.length} test files)`;
                    }
                  } else {
                    status = 'failure';
                    description = 'No test reports found';
                  }
                } else {
                  status = 'failure';
                  description = 'No test execution detected';
                }
              } catch (e) {
                console.log('Error reading test results:', e.message);
                status = 'error';
                description = 'Error reading test results';
              }
              
              console.log(`Creating status: ${status} - ${description}`);
              
            } catch (error) {
              console.log('Status creation skipped:', error.message);
            }
          } else {
            console.log('Skipping status creation for pull request');
          }

  # Deploy to GitHub Pages
  deploy:
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Report URL
      run: |
        echo "## üìä Allure Report Published!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üîó **View Report:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The latest test results are now available at the URL above." >> $GITHUB_STEP_SUMMARY