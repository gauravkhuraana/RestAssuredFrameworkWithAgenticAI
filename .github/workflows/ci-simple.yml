# Reliable API Test Automation
name: API Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'smoke'
        type: choice
        options:
        - smoke
        - regression
        - all

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run API Tests
      run: |
        SUITE=${{ github.event.inputs.test_suite || 'smoke' }}
        echo "Running $SUITE tests..."
        
        mvn clean test \
          -Denv=dev \
          -P${SUITE},ci \
          --batch-mode \
          --no-transfer-progress
      env:
        MAVEN_OPTS: "-Xmx1536m -Xms512m"

    - name: Display Test Results
      if: always()
      run: |
        echo "=== Test Execution Complete ==="
        
        if [ -d "target/surefire-reports" ]; then
          echo "✅ Test reports generated"
          
          # Simple test count
          XML_FILES=$(find target/surefire-reports -name "TEST-*.xml" 2>/dev/null || echo "")
          if [ -n "$XML_FILES" ]; then
            echo "📊 Test report files found:"
            ls -la target/surefire-reports/TEST-*.xml || true
          else
            echo "⚠️ No XML test reports found"
          fi
        else
          echo "❌ No surefire-reports directory found"
        fi
        
        # Show any log files
        if [ -d "logs" ]; then
          echo "📝 Log files available:"
          ls -la logs/ || true
        fi

    - name: Upload Test Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          target/surefire-reports/
          target/allure-results/
          test-output/
          logs/
        retention-days: 5
        if-no-files-found: ignore

    - name: Fail if tests failed
      if: always()
      run: |
        # Simple check - if Maven command failed, this step will catch it
        if [ -f target/surefire-reports/TEST-*.xml ]; then
          if grep -q 'failures="[1-9]' target/surefire-reports/TEST-*.xml; then
            echo "❌ Tests have failures"
            exit 1
          elif grep -q 'errors="[1-9]' target/surefire-reports/TEST-*.xml; then
            echo "❌ Tests have errors"  
            exit 1
          else
            echo "✅ All tests passed"
          fi
        fi
